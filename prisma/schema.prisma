generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  phone       String?  @unique
  password    String
  firstName   String
  lastName    String
  avatar      String?
  language    String   @default("en")
  timezone    String   @default("UTC")
  theme       String   @default("light")
  role        UserRole @default(HELPER)
  isActive    Boolean  @default(true)
  emailVerified Boolean @default(false)
  phoneVerified Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  masterAccount User?  @relation("MasterAccount", fields: [masterAccountId], references: [id])
  masterAccountId String?
  createdProfiles User[] @relation("MasterAccount")
  
  oauthProviders OAuthProvider[]
  sessions Session[]
  budgets Budget[]
  receipts Receipt[]
  notifications Notification[]
  otpCodes OtpCode[]

  @@index([email])
  @@index([phone])
  @@map("users")
}

model OAuthProvider {
  id           String           @id @default(cuid())
  userId       String
  provider     OAuthProviderType
  providerId   String
  accessToken  String?
  refreshToken String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@map("oauth_providers")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model OtpCode {
  id        String   @id @default(cuid())
  userId    String?
  email     String?
  phone     String?
  code      String
  type      OtpType
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("otp_codes")
}

model Budget {
  id          String          @id @default(cuid())
  name        String
  description String?
  amount      Decimal
  startDate   DateTime
  endDate     DateTime?
  isRecurring Boolean         @default(false)
  recurrence  BudgetRecurrence?
  isActive    Boolean         @default(true)
  createdBy   String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relations
  creator User @relation(fields: [createdBy], references: [id])
  receipts Receipt[]

  @@index([createdBy])
  @@map("budgets")
}

model Category {
  id          String @id @default(cuid())
  name        String
  nameZh      String?
  color       String @default("#1976d2")
  icon        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  items ReceiptItem[]

  @@map("categories")
}

model Receipt {
  id            String        @id @default(cuid())
  userId        String
  budgetId      String?
  storeName     String?
  storeNameZh   String?
  totalAmount   Decimal
  currency      String        @default("SGD")
  receiptNumber String?
  purchaseDate  DateTime
  imageUrl      String?
  thumbnailUrl  String?
  ocrConfidence Float?
  status        ReceiptStatus @default(PENDING)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id])
  budget Budget? @relation(fields: [budgetId], references: [id])
  items ReceiptItem[]

  @@index([userId])
  @@index([budgetId])
  @@map("receipts")
}

model ReceiptItem {
  id           String   @id @default(cuid())
  receiptId    String
  categoryId   String
  name         String
  nameZh       String?
  quantity     Decimal
  unitPrice    Decimal
  totalPrice   Decimal
  category     String?
  ocrConfidence Float?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  receipt Receipt @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  categoryRelation Category @relation(fields: [categoryId], references: [id])

  @@index([receiptId])
  @@index([categoryId])
  @@map("receipt_items")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  titleZh   String?
  message   String
  messageZh String?
  data      Json?            // Additional data for the notification
  isRead    Boolean          @default(false)
  emailSent Boolean          @default(false)
  smsSent   Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

enum UserRole {
  MASTER
  ADMIN
  FAMILY_MEMBER
  HELPER
}

enum OAuthProviderType {
  GOOGLE
  APPLE
}

enum OtpType {
  EMAIL_VERIFICATION
  PHONE_VERIFICATION
  PASSWORD_RESET
  LOGIN
}

enum ReceiptStatus {
  PENDING
  IN_PROGRESS
  PROCESSING
  COMPLETED
  FAILED
  MANUAL
}

enum BudgetRecurrence {
  WEEKLY
  BI_WEEKLY
  MONTHLY
}

enum NotificationType {
  BUDGET_THRESHOLD
  NEW_RECEIPT
  WEEKLY_SUMMARY
  UNUSUAL_SPENDING
  BUDGET_ASSIGNED
}